<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Redview Groups</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-storage-compat.js"></script>
    
    <style>
        /* Definir la fuente personalizada */
        @font-face {
            font-family: 'FuentePersonalizada';
            src: url('fuente.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
        }
        
        /* APLICAR FUENTE PERSONALIZADA A TODOS LOS ELEMENTOS Y TEXTOS */
        body, .title, .menu-title, 
        .card-title, .card-description,
        .group-title, .group-description,
        .publish-date, .form-label,
        .stat-label, .tag,
        .my-group-placeholder p,
        .my-group-stat-number, .my-group-stat-label, .my-group-tag,
        button, .card-button, .join-button, .publish-footer-button,
        .form-input, .publish-button, .close-menu, .back-button,
        .nav-label, .group-status, .stat-number,
        .admin-input, .admin-button, .request-item, .request-title,
        .request-description, .admin-section-title, .admin-actions,
        .admin-stats-number, .admin-stats-label, .admin-tab-button,
        .review-link-btn, .search-input, .close-search,
        .sticker-item, .sticker-modal-title, .sticker-modal-close,
        .sticker-upload-text, .sticker-delete-btn,
        .form-input-container, .sticker-inside-button,
        .content-editable {
            font-family: 'FuentePersonalizada', Arial, sans-serif !important;
        }
        
        body {
            margin: 0;
            padding: 0;
            height: 100vh;
            background-color: #121212;
            color: #ffffff;
            overflow-x: hidden;
        }
        
        .top-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background-color: #121212;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            border-bottom: 1px solid #333;
            z-index: 100;
            height: 60px;
            box-sizing: border-box;
        }
        
        .title {
            font-size: 18px;
            font-weight: bold;
            display: flex;
            align-items: center;
            cursor: pointer;
            transition: opacity 0.2s;
        }
        
        .title:hover {
            opacity: 0.8;
        }
        
        .heart {
            margin-right: 8px;
            font-size: 20px;
        }
        
        .search-icon {
            width: 24px;
            height: 24px;
            object-fit: contain;
            filter: brightness(0.9);
            cursor: pointer;
            display: block;
        }
        
        /* BARRA DE B√öSQUEDA - MISMO TAMA√ëO QUE TOP-BAR */
        .search-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background-color: #121212;
            display: none;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            border-bottom: 1px solid #333;
            z-index: 101;
            height: 60px;
            box-sizing: border-box;
        }
        
        .search-input-container {
            flex-grow: 1;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .search-input {
            flex-grow: 1;
            padding: 12px 16px;
            background-color: #2a2a2a;
            border: 1px solid #444;
            border-radius: 50px;
            color: #fff;
            font-size: 14px;
            outline: none;
            transition: border-color 0.2s;
        }
        
        .search-input:focus {
            border-color: #444;
            box-shadow: none;
            outline: none;
        }
        
        .search-input:-webkit-autofill,
        .search-input:-webkit-autofill:hover,
        .search-input:-webkit-autofill:focus {
            -webkit-text-fill-color: #fff;
            -webkit-box-shadow: 0 0 0px 1000px #2a2a2a inset;
            transition: background-color 5000s ease-in-out 0s;
            border: 1px solid #444;
            border-radius: 50px;
        }
        
        .close-search {
            background-color: #2a2a2a;
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 20px;
            transition: background-color 0.2s;
            flex-shrink: 0;
            outline: none;
        }
        
        .close-search:hover {
            background-color: #3a3a3a;
        }
        
        .close-search:focus {
            outline: none;
            box-shadow: none;
        }
        
        /* MODAL DE CONTRASE√ëA ADMIN */
        .admin-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.85);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        
        .admin-modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        
        .admin-modal {
            background-color: #1e1e1e;
            border-radius: 20px;
            padding: 30px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            text-align: center;
            transform: translateY(-20px);
            transition: transform 0.3s ease;
        }
        
        .admin-modal-overlay.active .admin-modal {
            transform: translateY(0);
        }
        
        .admin-modal-title {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #fff;
        }
        
        .admin-modal-subtitle {
            font-size: 14px;
            color: #bbb;
            margin-bottom: 25px;
        }
        
        .admin-modal-input {
            width: 100%;
            padding: 14px;
            background-color: #2a2a2a;
            border: 2px solid #444;
            border-radius: 10px;
            color: #fff;
            font-size: 16px;
            margin-bottom: 20px;
            text-align: center;
            transition: border-color 0.2s;
        }
        
        .admin-modal-input:focus {
            outline: none;
            border-color: #2575fc;
        }
        
        .admin-modal-input::placeholder {
            color: #777;
        }
        
        .admin-modal-button {
            width: 100%;
            padding: 14px;
            background-color: #2575fc;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s;
            margin-bottom: 15px;
        }
        
        .admin-modal-button:hover {
            background-color: #1c64e0;
        }
        
        .admin-modal-close {
            background: none;
            border: none;
            color: #bbb;
            font-size: 14px;
            cursor: pointer;
            margin-top: 10px;
            transition: color 0.2s;
        }
        
        .admin-modal-close:hover {
            color: #fff;
        }
        
        /* MODAL DE STICKERS */
        .stickers-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2001;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        
        .stickers-modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        
        .stickers-modal {
            background-color: #1e1e1e;
            border-radius: 20px;
            padding: 20px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            transform: translateY(-20px);
            transition: transform 0.3s ease;
        }
        
        .stickers-modal-overlay.active .stickers-modal {
            transform: translateY(0);
        }
        
        .stickers-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .stickers-modal-title {
            font-size: 20px;
            font-weight: bold;
            color: #fff;
        }
        
        .stickers-modal-close {
            background: none;
            border: none;
            color: #fff;
            font-size: 30px;
            cursor: pointer;
            padding: 0;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background-color 0.2s;
        }
        
        .stickers-modal-close:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        /* STICKERS GRID - 4 COLUMNAS SIEMPRE (FORZADO) */
        .stickers-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr) !important; /* FORZADO 4 COLUMNAS */
            gap: 10px; /* Reducido un poco para que quepan mejor */
            margin-bottom: 20px;
        }
        
        /* Eliminar media queries que reduc√≠an columnas */
        
        .sticker-item {
            border-radius: 10px;
            overflow: hidden;
            cursor: pointer;
            border: 2px solid transparent;
            transition: border-color 0.2s, transform 0.2s;
            background-color: #2a2a2a; /* Fondo para que se vea el √°rea */
            aspect-ratio: 1/1; /* Mantener cuadrado */
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .sticker-item:hover {
            border-color: #2575fc;
            transform: scale(1.05);
        }
        
        .sticker-image {
            width: 100%;
            height: 100%;
            object-fit: contain;
            padding: 5px;
        }
        
        /* CONTENEDOR DE SUBIDA DE STICKERS */
        .sticker-upload-container {
            background-color: #2a2a2a;
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
            text-align: center;
        }
        
        .sticker-upload-area {
            border: 2px dashed #444;
            border-radius: 10px;
            padding: 30px 20px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: border-color 0.2s, background-color 0.2s;
        }
        
        .sticker-upload-area:hover {
            border-color: #2575fc;
            background-color: #2d2d2d;
        }
        
        .sticker-upload-text {
            font-size: 14px;
            color: #bbb;
            margin-top: 10px;
        }
        
        .sticker-delete-btn {
            background-color: #e74c3c;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 5px 10px;
            font-size: 11px;
            cursor: pointer;
            transition: background-color 0.2s;
            margin-top: 5px;
            width: 100%;
        }
        
        .sticker-delete-btn:hover {
            background-color: #c0392b;
        }
        
        /* CONTENEDOR PARA CAMPOS EDITABLES CON STICKERS */
        .form-input-container {
            position: relative;
            width: 100%;
        }
        
        .content-editable {
            width: 100%;
            min-height: 44px;
            max-height: 200px;
            overflow-y: auto;
            padding: 12px 45px 12px 14px;
            background-color: #2a2a2a;
            border: 1px solid #444;
            border-radius: 10px;
            color: #fff;
            font-size: 14px;
            box-sizing: border-box;
            transition: border-color 0.2s;
            outline: none;
            white-space: pre-wrap;
            word-wrap: break-word;
            line-height: 1.4;
        }
        
        .content-editable:focus {
            outline: none;
            border-color: #2575fc;
        }
        
        /* Placeholder para contenteditable */
        .content-editable[data-placeholder]:empty:before {
            content: attr(data-placeholder);
            color: #777;
            position: absolute;
            pointer-events: none;
        }
        
        /* Estilo para im√°genes dentro de contenteditable */
        .content-editable img {
            display: inline-block;
            vertical-align: middle;
            max-width: 24px;
            max-height: 24px;
            margin: 0 2px;
            object-fit: contain;
        }
        
        /* Para GIFs dentro de contenteditable */
        .content-editable img[data-sticker] {
            width: 24px;
            height: 24px;
            object-fit: contain;
        }
        
        .sticker-inside-button {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            cursor: pointer;
            padding: 5px;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            transition: background-color 0.2s;
            z-index: 2;
        }
        
        .sticker-inside-button:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        .sticker-inside-button img {
            width: 18px;
            height: 18px;
            object-fit: contain;
            filter: brightness(1); /* Ajustado para el nuevo icono colorido */
        }
        
        /* Campos regulares (para etiquetas y enlace) */
        .form-input {
            width: 100%;
            padding: 12px 14px;
            background-color: #2a2a2a;
            border: 1px solid #444;
            border-radius: 10px;
            color: #fff;
            font-size: 14px;
            box-sizing: border-box;
            transition: border-color 0.2s;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #2575fc;
        }
        
        .form-input::placeholder {
            color: #777;
        }
        
        textarea.form-input {
            resize: vertical;
            min-height: 80px;
        }
        
        /* Contenido principal */
        .main-content {
            padding: 75px 16px 120px;
            max-width: 800px;
            margin: 0 auto;
            transition: opacity 0.3s ease;
        }
        
        /* Contenido para Mis Grupos (oculto por defecto) */
        .my-groups-content {
            padding: 75px 16px 120px;
            max-width: 800px;
            margin: 0 auto;
            display: none;
        }
        
        /* Contenido para Admin (oculto por defecto) */
        .admin-content {
            padding: 75px 16px 120px;
            max-width: 800px;
            margin: 0 auto;
            display: none;
        }
        
        body.show-my-groups .main-content {
            display: none;
        }
        
        body.show-my-groups .my-groups-content {
            display: block;
        }
        
        body.show-admin .main-content {
            display: none;
        }
        
        body.show-admin .admin-content {
            display: block;
        }
        
        body.show-admin .my-groups-content {
            display: none;
        }
        
        /* DOS COLUMNAS SIEMPRE */
        .cards-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            width: 100%;
        }
        
        /* UNA COLUMNA PARA MIS GRUPOS */
        .my-groups-container {
            display: flex;
            flex-direction: column;
            gap: 16px;
            width: 100%;
        }
        
        /* CONTENEDOR PARA SOLICITUDES DE ADMIN */
        .requests-container {
            display: flex;
            flex-direction: column;
            gap: 16px;
            width: 100%;
        }
        
        /* RECUADRO DE ESTAD√çSTICAS ADMIN */
        .admin-stats-container {
            background-color: #1e1e1e;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 25px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }
        
        .admin-stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 15px;
            background-color: #2a2a2a;
            border-radius: 12px;
        }
        
        .admin-stats-number {
            font-size: 32px;
            font-weight: bold;
            color: #ffffff;
            margin-bottom: 8px;
        }
        
        .admin-stats-label {
            font-size: 14px;
            color: #bbb;
        }
        
        /* PESTA√ëAS DE ADMIN */
        .admin-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }
        
        .admin-tab-button {
            padding: 12px 20px;
            background-color: #2a2a2a;
            border: 2px solid #444;
            border-radius: 8px;
            color: #bbb;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            flex: 1;
            min-width: 120px;
            text-align: center;
        }
        
        .admin-tab-button.active {
            background-color: #2575fc;
            color: white;
            border-color: #2575fc;
        }
        
        .admin-tab-button:hover:not(.active) {
            background-color: #3a3a3a;
            color: #ddd;
        }
        
        /* CONTENIDO DE LAS PESTA√ëAS (oculto por defecto) */
        .admin-tab-content {
            display: none;
        }
        
        .admin-tab-content.active {
            display: block;
        }
        
        /* IMAGEN EN SOLICITUDES PENDIENTES */
        .request-image-container {
            width: 100%;
            height: 150px;
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 12px;
        }
        
        .request-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .request-item {
            background-color: #1e1e1e;
            border-radius: 15px;
            padding: 16px;
            margin-bottom: 12px;
            border-left: 4px solid #f39c12;
        }
        
        .request-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .request-title {
            font-size: 16px;
            font-weight: bold;
            color: #fff;
            margin: 0;
        }
        
        .request-date {
            font-size: 12px;
            color: #bbb;
        }
        
        .request-description {
            font-size: 14px;
            color: #ddd;
            line-height: 1.4;
            margin-bottom: 12px;
        }
        
        .request-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 16px;
        }
        
        .request-tag {
            background-color: #2a2a2a;
            color: #ddd;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 11px;
        }
        
        /* ACCIONES EN SOLICITUDES */
        .request-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .request-actions .review-link-btn,
        .request-actions .reject-btn,
        .request-actions .accept-btn {
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: background-color 0.2s;
            border: none;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }
        
        .review-link-btn {
            background-color: #3498db;
            color: white;
        }
        
        .review-link-btn:hover {
            background-color: #2980b9;
        }
        
        .accept-btn {
            background-color: #2ecc71;
            color: white;
        }
        
        .accept-btn:hover {
            background-color: #27ae60;
        }
        
        .reject-btn {
            background-color: #e74c3c;
            color: white;
        }
        
        .reject-btn:hover {
            background-color: #c0392b;
        }
        
        .admin-section-title {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 20px;
            color: #fff;
            text-align: center;
        }
        
        .admin-input-container {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            margin-bottom: 20px;
        }
        
        .admin-input {
            flex-grow: 1;
            padding: 10px 14px;
            background-color: #2a2a2a;
            border: 1px solid #444;
            border-radius: 10px;
            color: #fff;
            font-size: 14px;
        }
        
        .admin-button {
            padding: 10px 20px;
            background-color: #2575fc;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .admin-button:hover {
            background-color: #1c64e0;
        }
        
        .card {
            background-color: #1e1e1e;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
            width: 100%;
            min-width: 0;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.3);
        }
        
        .card-image {
            width: 100%;
            height: 120px;
            object-fit: cover;
        }
        
        .card-content {
            padding: 12px;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }
        
        .card-title {
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 6px;
            color: #ffffff;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .card-description {
            font-size: 12px;
            color: #bbb;
            line-height: 1.4;
            margin-bottom: 12px;
            flex-grow: 1;
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
        }
        
        .card-button {
            display: block;
            width: 100%;
            padding: 8px;
            background-color: #2ecc71;
            color: white;
            border: none;
            border-radius: 100px;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s;
            text-align: center;
            text-decoration: none;
            box-sizing: border-box;
        }
        
        .card-button:hover {
            background-color: #27ae60;
        }
        
        .admin-delete-btn {
            background-color: #e74c3c;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 6px 12px;
            font-size: 12px;
            cursor: pointer;
            transition: background-color 0.2s;
            margin-top: 5px;
            width: 100%;
        }
        
        .admin-delete-btn:hover {
            background-color: #c0392b;
        }
        
        .my-group-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-bottom: 12px;
            padding: 0;
        }
        
        .my-group-tag {
            background-color: #2a2a2a;
            color: #ddd;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 10px;
        }
        
        .my-group-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: auto;
            padding-top: 10px;
            border-top: 1px solid #333;
        }
        
        .my-group-stats {
            display: flex;
            gap: 16px;
        }
        
        .my-group-stat {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        
        .my-group-stat-number {
            font-size: 14px;
            font-weight: bold;
            color: #ffffff;
        }
        
        .my-group-stat-label {
            font-size: 9px;
            color: #bbb;
            margin-top: 2px;
        }
        
        .group-status {
            display: inline-block;
            padding: 6px 16px;
            border-radius: 100px;
            font-size: 11px;
            font-weight: bold;
            text-align: center;
            white-space: nowrap;
        }
        
        .status-review {
            background-color: #f39c12;
            color: white;
        }
        
        .status-published {
            background-color: #2ecc71;
            color: white;
        }
        
        .status-rejected {
            background-color: #e74c3c;
            color: white;
        }
        
        /* MEN√öS LATERALES */
        .side-menu {
            position: fixed;
            top: 0;
            right: -100%;
            width: 100%;
            height: 100vh;
            background-color: #121212;
            z-index: 1000;
            transition: right 0.3s ease;
            overflow-y: auto;
        }
        
        body.menu-open .side-menu {
            right: 0;
        }
        
        .group-details-menu {
            position: fixed;
            top: 0;
            right: -100%;
            width: 100%;
            height: 100vh;
            background-color: #1a1a1a;
            z-index: 1000;
            transition: right 0.3s ease;
            overflow-y: auto;
        }
        
        body.group-details-open .group-details-menu {
            right: 0;
        }
        
        .menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 999;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        
        body.menu-open .menu-overlay,
        body.group-details-open .menu-overlay {
            opacity: 1;
            visibility: visible;
        }
        
        .details-header {
            background-color: #121212;
            padding: 16px;
            border-bottom: 1px solid #333;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .back-button {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .back-arrow {
            width: 24px;
            height: 24px;
            object-fit: contain;
        }
        
        .publish-date {
            font-size: 14px;
            color: #bbb;
            flex-grow: 1;
            text-align: center;
        }
        
        .details-content {
            padding: 0;
            max-width: 500px;
            margin: 0 auto;
            padding-bottom: 100px;
        }
        
        .group-image-large {
            width: calc(100% - 40px);
            height: 200px;
            object-fit: cover;
            border-radius: 15px;
            margin: 20px auto;
            display: block;
        }
        
        .group-title {
            font-size: 22px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #ffffff;
            padding: 0 20px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .group-description {
            font-size: 16px;
            color: #ddd;
            line-height: 1.6;
            margin-bottom: 20px;
            padding: 0 20px;
        }
        
        .group-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 25px;
            padding: 0 20px;
        }
        
        .tag {
            background-color: #2a2a2a;
            color: #ddd;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
        }
        
        .stats-container {
            background-color: #2a2a2a;
            border-radius: 15px;
            padding: 20px;
            margin: 0 20px 25px 20px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            text-align: center;
        }
        
        .stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #ffffff;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 12px;
            color: #bbb;
        }
        
        .details-footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: #1e1e1e;
            padding: 16px;
            border-top: 1px solid #333;
            display: flex;
            align-items: center;
            z-index: 1001;
            display: none;
        }
        
        body.group-details-open .details-footer {
            display: flex;
        }
        
        .join-button {
            flex-grow: 1;
            padding: 14px;
            background-color: #2ecc71;
            color: white;
            border: none;
            border-radius: 100px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s;
            text-decoration: none;
            text-align: center;
        }
        
        .join-button:hover {
            background-color: #27ae60;
        }
        
        .menu-content {
            padding: 20px;
            max-width: 500px;
            margin: 0 auto;
            padding-bottom: 100px;
        }
        
        .menu-header {
            background-color: #121212;
            padding: 10px 16px;
            border-bottom: 1px solid #333;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .menu-title {
            font-size: 18px;
            font-weight: bold;
        }
        
        .publish-footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: #1e1e1e;
            padding: 16px;
            border-top: 1px solid #333;
            display: flex;
            align-items: center;
            z-index: 1001;
            display: none;
        }
        
        body.menu-open .publish-footer {
            display: flex;
        }
        
        .publish-footer-button {
            flex-grow: 1;
            padding: 14px;
            background-color: #2575fc;
            color: white;
            border: none;
            border-radius: 100px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .publish-footer-button:hover {
            background-color: #1c64e0;
        }
        
        .close-menu {
            background: none;
            border: none;
            color: #fff;
            font-size: 32px;
            cursor: pointer;
            padding: 0;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background-color 0.2s;
        }
        
        .close-menu:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        .image-upload {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background-color: #2a2a2a;
            margin: 0 auto 25px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: 2px dashed #444;
            transition: border-color 0.2s, background-color 0.2s;
            position: relative;
            overflow: hidden;
        }
        
        .image-upload:hover {
            border-color: #2575fc;
            background-color: #2d2d2d;
        }
        
        .image-upload-icon {
            font-size: 28px;
            margin-bottom: 6px;
        }
        
        .image-upload-text {
            font-size: 10px;
            color: #aaa;
            text-align: center;
            padding: 0 5px;
        }
        
        .image-preview {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
            position: absolute;
            top: 0;
            left: 0;
            display: none;
        }
        
        .image-upload.has-image .image-upload-icon,
        .image-upload.has-image .image-upload-text {
            display: none;
        }
        
        .image-upload.has-image .image-preview {
            display: block;
        }
        
        .upload-input {
            display: none;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            font-size: 14px;
            margin-bottom: 8px;
            color: #ddd;
        }
        
        .publish-button {
            display: none;
        }
        
        .bottom-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: #1e1e1e;
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 8px 0;
            border-top: 1px solid #333;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.2);
            z-index: 100;
        }
        
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-decoration: none;
            color: #bbb;
            flex: 1;
            padding: 6px 0;
            transition: color 0.2s;
            outline: none;
            -webkit-tap-highlight-color: transparent;
            cursor: pointer;
        }
        
        .nav-item.active {
            color: #ffffff;
        }
        
        .nav-item:focus, .nav-item:active {
            outline: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        .nav-item:hover {
            color: #ffffff;
        }
        
        .nav-icon {
            width: 22px;
            height: 22px;
            object-fit: contain;
            margin-bottom: 4px;
            filter: brightness(0.9);
            transition: filter 0.2s;
        }
        
        .nav-item.active .nav-icon {
            filter: brightness(1);
        }
        
        .nav-label {
            font-size: 10px;
            font-weight: 500;
        }
        
        .center-button {
            position: relative;
            z-index: 1;
        }
        
        .center-button .nav-icon {
            width: 26px;
            height: 26px;
        }
        
        .center-button .nav-label {
            font-weight: 600;
        }
        
        * {
            -webkit-tap-highlight-color: transparent;
            box-sizing: border-box;
        }
        
        @media (max-width: 360px) {
            .card-image {
                height: 100px;
            }
            
            .card-content {
                padding: 10px;
            }
            
            .card-title {
                font-size: 13px;
            }
            
            .card-description {
                font-size: 11px;
            }
            
            .cards-container {
                gap: 10px;
            }
            
            .main-content, .my-groups-content, .admin-content {
                padding: 70px 12px 120px;
            }
            
            .menu-content, .details-content {
                padding: 0;
            }
            
            .group-image-large {
                height: 150px;
                width: calc(100% - 30px);
                border-radius: 12px;
            }
            
            .group-title {
                font-size: 18px;
            }
            
            .group-description {
                font-size: 14px;
            }
            
            .stats-container {
                margin: 0 15px 25px 15px;
            }
            
            .menu-content {
                padding-bottom: 90px;
            }
            
            .group-status {
                padding: 5px 12px;
                font-size: 10px;
            }
            
            .my-group-stat-number {
                font-size: 12px;
            }
            
            .my-group-stat-label {
                font-size: 8px;
            }
            
            .request-item {
                padding: 12px;
            }
            
            .request-title {
                font-size: 14px;
            }
            
            .request-description {
                font-size: 12px;
            }
            
            .admin-modal {
                padding: 20px;
                width: 95%;
            }
            
            .admin-modal-title {
                font-size: 20px;
            }
            
            .admin-stats-number {
                font-size: 24px;
            }
            
            .admin-stats-label {
                font-size: 12px;
            }
            
            .request-image-container {
                height: 120px;
            }
            
            .request-actions {
                flex-direction: column;
                gap: 8px;
            }
            
            .request-actions .review-link-btn,
            .request-actions .reject-btn,
            .request-actions .accept-btn {
                width: 100%;
            }
            
            .search-input {
                padding: 10px 14px;
                font-size: 13px;
            }
            
            .close-search {
                width: 36px;
                height: 36px;
                font-size: 18px;
            }
            
            .top-bar, .search-bar {
                height: 56px;
                padding: 10px 14px;
            }
            
            .edit-group-btn {
                padding: 4px 8px !important;
                font-size: 10px !important;
            }
            
            .sticker-image {
                height: 70px;
            }
            
            .admin-tabs {
                flex-direction: column;
            }
            
            .admin-tab-button {
                width: 100%;
            }
            
            .content-editable {
                min-height: 40px;
                padding: 10px 40px 10px 12px;
                font-size: 13px;
            }
        }
        
        .edit-group-btn {
            background: none;
            border: 1px solid #3498db;
            color: #3498db;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
            margin-left: 10px;
        }
        
        .edit-group-btn:hover {
            background-color: #3498db;
            color: white;
        }
        
        .delete-group-btn {
            background: none;
            border: 1px solid #e74c3c;
            color: #e74c3c;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .delete-group-btn:hover {
            background-color: #e74c3c;
            color: white;
        }
        
        .my-group-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
            justify-content: flex-end;
        }
        
        @media (min-width: 768px) {
            .side-menu, .group-details-menu {
                width: 400px;
                right: -400px;
            }
            
            .menu-content, .details-content {
                max-width: 350px;
            }
            
            .details-content {
                padding-bottom: 100px;
            }
            
            .details-footer, .publish-footer {
                width: 400px;
                left: auto;
                right: 0;
            }
            
            .group-image-large {
                width: calc(100% - 40px);
                border-radius: 15px;
            }
        }
        
        /* LOADING SPINNER */
        .loading-spinner {
            display: none;
            text-align: center;
            padding: 40px;
        }
        
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-left-color: #2575fc;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <header class="top-bar">
        <div class="title" id="adminTitleButton">
            <span class="heart">‚ù§Ô∏è‚Äçüî•</span>
            <span> Ä·¥á·¥Ö·¥†…™·¥á·¥°</span>
        </div>
        <img src="https://i.ibb.co/n84F5wwC/lupa.png" alt="Buscar" class="search-icon" id="searchIcon">
    </header>
    
    <div class="search-bar" id="searchBar">
        <div class="search-input-container">
            <input type="text" class="search-input" id="searchInput" placeholder="Buscando.. (ej: Hentai, Femboys)">
            <button class="close-search" id="closeSearch">√ó</button>
        </div>
    </div>

    <div class="admin-modal-overlay" id="adminModalOverlay">
        <div class="admin-modal">
            <h2 class="admin-modal-title">Acceso de Administrador</h2>
            <p class="admin-modal-subtitle">Ingresa la contrase√±a para convertirte en administrador</p>
            <input type="password" class="admin-modal-input" id="adminModalPassword" placeholder="Contrase√±a">
            <button class="admin-modal-button" id="adminModalSubmit">Acceder</button>
            <button class="admin-modal-close" id="adminModalClose">Cancelar</button>
        </div>
    </div>

    <div class="stickers-modal-overlay" id="stickersModalOverlay">
        <div class="stickers-modal">
            <div class="stickers-modal-header">
                <h2 class="stickers-modal-title">üé® Stickers</h2>
                <button class="stickers-modal-close" id="stickersModalClose">√ó</button>
            </div>
            <div class="stickers-grid" id="stickersGrid">
                </div>
            <div class="sticker-upload-container" id="stickerUploadContainer" style="display: none;">
                <div class="sticker-upload-area" id="stickerUploadArea">
                    <input type="file" id="stickerFileInput" accept="image/*,image/gif" style="display: none;">
                    <div>üìÅ</div>
                    <div class="sticker-upload-text">Arrastra o haz clic para subir un sticker</div>
                </div>
                <button class="admin-button" id="uploadStickerButton">Subir Sticker</button>
            </div>
        </div>
    </div>

    <main class="main-content">
        <div class="loading-spinner" id="mainLoading">
            <div class="spinner"></div>
            <p>Cargando grupos...</p>
        </div>
        <div class="cards-container" id="mainCardsContainer">
            </div>
    </main>

    <div class="my-groups-content">
        <div class="loading-spinner" id="myGroupsLoading">
            <div class="spinner"></div>
            <p>Cargando tus grupos...</p>
        </div>
        <div class="my-groups-container" id="myGroupsContainer">
            </div>
    </div>

    <div class="admin-content">
        <h2 class="admin-section-title">Panel de Administraci√≥n</h2>
        
        <div class="admin-stats-container">
            <div class="admin-stat-item">
                <div class="admin-stats-number" id="statsPublished">0</div>
                <div class="admin-stats-label">Grupos Publicados</div>
            </div>
            <div class="admin-stat-item">
                <div class="admin-stats-number" id="statsPending">0</div>
                <div class="admin-stats-label">Grupos en Espera</div>
            </div>
        </div>
        
        <div class="admin-tabs">
            <button class="admin-tab-button active" id="pendingTab">Solicitudes Pendientes</button>
            <button class="admin-tab-button" id="publishedTab">Grupos Publicados</button>
            <button class="admin-tab-button" id="stickersTab">Stickers</button>
        </div>
        
        <div class="admin-tab-content active" id="pendingContent">
            <div class="loading-spinner" id="pendingLoading">
                <div class="spinner"></div>
                <p>Cargando solicitudes...</p>
            </div>
            <div class="requests-container" id="requestsContainer">
                </div>
        </div>
        
        <div class="admin-tab-content" id="publishedContent">
            <div class="loading-spinner" id="publishedLoading">
                <div class="spinner"></div>
                <p>Cargando grupos publicados...</p>
            </div>
            <div class="my-groups-container" id="adminPublishedContainer">
                </div>
        </div>
        
        <div class="admin-tab-content" id="stickersContent">
            <div class="loading-spinner" id="stickersLoading">
                <div class="spinner"></div>
                <p>Cargando stickers...</p>
            </div>
            <div class="admin-section-title">Gesti√≥n de Stickers</div>
            <div class="sticker-upload-container">
                <div class="sticker-upload-area" id="adminStickerUploadArea">
                    <input type="file" id="adminStickerFileInput" accept="image/*,image/gif" style="display: none;">
                    <div>üìÅ</div>
                    <div class="sticker-upload-text">Arrastra o haz clic para subir un sticker (GIF o imagen)</div>
                </div>
                <button class="admin-button" id="adminUploadStickerButton">Subir Sticker</button>
            </div>
            <div class="stickers-grid" id="adminStickersGrid">
                </div>
        </div>
    </div>

    <div class="side-menu">
        <div class="menu-header">
            <div class="menu-title" id="menuTitle">‚ù§Ô∏è‚Äçüî• Subir mi Grupo</div>
            <button class="close-menu">√ó</button>
        </div>
        
        <div class="menu-content">
            <div class="image-upload" id="imageUpload">
                <div class="image-upload-icon">üñºÔ∏è</div>
                <div class="image-upload-text">Seleccionar imagen</div>
                <img src="" alt="Vista previa" class="image-preview" id="imagePreview">
                <input type="file" accept="image/*" class="upload-input" id="fileInput">
            </div>
            
            <div class="form-group">
                <label class="form-label" for="groupName">Nombre del grupo</label>
                <div class="form-input-container">
                    <div id="groupNameEditable" class="content-editable" 
                         contenteditable="true" 
                         data-placeholder="Ej: Inversiones Internacionales"></div>
                    <input type="hidden" id="groupName" value="">
                    <button class="sticker-inside-button" id="stickerButtonName">
                        <img src="https://i.ibb.co/M3SG1JK/1f3a8-color.webp" alt="A√±adir sticker">
                    </button>
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label" for="groupDescription">Descripci√≥n</label>
                <div class="form-input-container">
                    <div id="groupDescriptionEditable" class="content-editable" 
                         contenteditable="true" 
                         data-placeholder="Describe de qu√© trata el grupo..."></div>
                    <input type="hidden" id="groupDescription" value="">
                    <button class="sticker-inside-button" id="stickerButtonDescription">
                        <img src="https://i.ibb.co/M3SG1JK/1f3a8-color.webp" alt="A√±adir sticker">
                    </button>
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label" for="groupTags">Etiquetas</label>
                <input type="text" id="groupTags" class="form-input" placeholder="Ej: finanzas, inversiones, negocios">
            </div>
            
            <div class="form-group">
                <label class="form-label" for="groupLink">Enlace del grupo</label>
                <input type="url" id="groupLink" class="form-input" placeholder="https://ejemplo.com/grupo">
            </div>
            
            <input type="hidden" id="editingGroupId" value="">
            <input type="hidden" id="editingGroupType" value="">
            <input type="hidden" id="currentStickerTarget" value="">
            
            <button class="publish-button" id="publishButton">Publicar Grupo</button>
        </div>
        
        <div class="publish-footer">
            <button class="publish-footer-button" id="publishFooterButton">Publicar Grupo</button>
        </div>
    </div>
    
    <div class="group-details-menu">
        <div class="details-content">
            <div class="details-header">
                <button class="back-button" id="backButton">
                    <img src="https://i.ibb.co/k6Vmd994/flecha.png" alt="Volver" class="back-arrow">
                </button>
                <div class="publish-date" id="publishDate">Publicado: 15 de marzo, 2024</div>
                <div style="width: 40px;"></div>
            </div>
            
            <img src="" alt="Imagen del grupo" class="group-image-large" id="groupImageLarge">
            
            <h2 class="group-title" id="groupTitle"></h2>
            
            <p class="group-description" id="groupDescriptionDetails"></p>
            
            <div class="group-tags" id="groupTagsDetails"></div>
            
            <div class="stats-container">
                <div class="stat-item">
                    <div class="stat-number" id="viewsCount">0</div>
                    <div class="stat-label">Visualizaciones</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="membersCount">0</div>
                    <div class="stat-label">Uniones</div>
                </div>
            </div>
        </div>
        
        <div class="details-footer">
            <button class="join-button" id="joinButton">Unirse al grupo</button>
        </div>
    </div>
    
    <div class="menu-overlay" id="menuOverlay"></div>

    <footer class="bottom-bar">
        <div class="nav-item active" id="homeButton">
            <img src="https://i.ibb.co/Z1wD350f/home.png" alt="Inicio" class="nav-icon">
            <span class="nav-label">Inicio</span>
        </div>
        
        <div class="nav-item center-button" id="menuButton">
            <img src="https://i.ibb.co/qF03jpFH/mas.png" alt="Publicar" class="nav-icon">
            <span class="nav-label">Publicar</span>
        </div>
        
        <div class="nav-item" id="myGroupsButton">
            <img src="https://i.ibb.co/7JZmyK0w/publicacion.png" alt="Mis grupos" class="nav-icon">
            <span class="nav-label">Mis grupos</span>
        </div>
        
        <div class="nav-item" id="adminButton" style="display: none;">
            <img src="https://i.ibb.co/V6N69ZM/escudo-antimalware.png" alt="Admin" class="nav-icon">
            <span class="nav-label">Admin</span>
        </div>
    </footer>

    <script>
        // Configuraci√≥n de Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyB6SoLg-a8bZG9KSdFRH4NyoBDCps0dYCg",
            authDomain: "redview-31953.firebaseapp.com",
            databaseURL: "https://redview-31953-default-rtdb.firebaseio.com",
            projectId: "redview-31953",
            storageBucket: "redview-31953.firebasestorage.app",
            messagingSenderId: "316847343520",
            appId: "1:316847343520:web:d05a6c2b5cccfd1b57c6c5"
        };

        // Inicializar Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const storage = firebase.storage();

        // Elementos del DOM
        const body = document.body;
        const menuButton = document.getElementById('menuButton');
        const closeMenuButton = document.querySelector('.close-menu');
        const menuOverlay = document.getElementById('menuOverlay');
        const imageUpload = document.getElementById('imageUpload');
        const fileInput = document.getElementById('fileInput');
        const imagePreview = document.getElementById('imagePreview');
        const publishButton = document.getElementById('publishButton');
        const publishFooterButton = document.getElementById('publishFooterButton');
        const backButton = document.getElementById('backButton');
        const joinButton = document.getElementById('joinButton');
        const homeButton = document.getElementById('homeButton');
        const myGroupsButton = document.getElementById('myGroupsButton');
        const myGroupsContainer = document.getElementById('myGroupsContainer');
        const adminButton = document.getElementById('adminButton');
        const requestsContainer = document.getElementById('requestsContainer');
        const adminPublishedContainer = document.getElementById('adminPublishedContainer');
        const mainCardsContainer = document.getElementById('mainCardsContainer');
        const searchIcon = document.getElementById('searchIcon');
        const menuTitle = document.getElementById('menuTitle');
        const editingGroupId = document.getElementById('editingGroupId');
        const editingGroupType = document.getElementById('editingGroupType');
        const currentStickerTarget = document.getElementById('currentStickerTarget');
        
        // Nuevos elementos para campos editables
        const groupNameEditable = document.getElementById('groupNameEditable');
        const groupDescriptionEditable = document.getElementById('groupDescriptionEditable');
        const groupNameHidden = document.getElementById('groupName');
        const groupDescriptionHidden = document.getElementById('groupDescription');
        
        // Elementos de b√∫squeda
        const searchBar = document.getElementById('searchBar');
        const searchInput = document.getElementById('searchInput');
        const closeSearch = document.getElementById('closeSearch');
        
        // Elementos del modal de admin
        const adminTitleButton = document.getElementById('adminTitleButton');
        const adminModalOverlay = document.getElementById('adminModalOverlay');
        const adminModalPassword = document.getElementById('adminModalPassword');
        const adminModalSubmit = document.getElementById('adminModalSubmit');
        const adminModalClose = document.getElementById('adminModalClose');
        
        // Elementos de pesta√±as admin
        const pendingTab = document.getElementById('pendingTab');
        const publishedTab = document.getElementById('publishedTab');
        const stickersTab = document.getElementById('stickersTab');
        const pendingContent = document.getElementById('pendingContent');
        const publishedContent = document.getElementById('publishedContent');
        const stickersContent = document.getElementById('stickersContent');
        
        // Elementos de stickers
        const stickersModalOverlay = document.getElementById('stickersModalOverlay');
        const stickersModalClose = document.getElementById('stickersModalClose');
        const stickersGrid = document.getElementById('stickersGrid');
        const stickerButtonName = document.getElementById('stickerButtonName');
        const stickerButtonDescription = document.getElementById('stickerButtonDescription');
        const adminStickersGrid = document.getElementById('adminStickersGrid');
        const adminStickerUploadArea = document.getElementById('adminStickerUploadArea');
        const adminStickerFileInput = document.getElementById('adminStickerFileInput');
        const adminUploadStickerButton = document.getElementById('adminUploadStickerButton');
        
        // Elementos de estad√≠sticas
        const statsPublished = document.getElementById('statsPublished');
        const statsPending = document.getElementById('statsPending');
        
        // Elementos de loading
        const mainLoading = document.getElementById('mainLoading');
        const myGroupsLoading = document.getElementById('myGroupsLoading');
        const pendingLoading = document.getElementById('pendingLoading');
        const publishedLoading = document.getElementById('publishedLoading');
        const stickersLoading = document.getElementById('stickersLoading');
        
        // Variables globales
        let currentUserId = null;
        let currentGroupDetails = null;
        let isAdmin = false;
        const ADMIN_PASSWORD = '200506';
        let uploadedImageFile = null;
        let isEditing = false;
        let currentEditGroupKey = null;
        let currentEditGroupType = null;
        let stickersList = [];
        let stickersMap = new Map(); // Para mapear stickers por key
        
        // ========== FUNCI√ìN DE CARGA INICIAL OPTIMIZADA ==========
        
        // Funci√≥n dedicada solo para cargar datos de stickers (sin renderizar UI)
        async function loadStickersData() {
            try {
                const snapshot = await database.ref('stickers').once('value');
                const stickers = snapshot.val();
                
                if (stickers) {
                    stickersMap.clear();
                    // Llenar el mapa inmediatamente
                    for (const key in stickers) {
                        stickersMap.set(key, stickers[key].data);
                    }
                }
                return true;
            } catch (error) {
                console.error('Error precargando stickers:', error);
                return false;
            }
        }

        // ========== FUNCIONES DE STICKERS ==========
        
        // Funci√≥n para abrir modal de stickers
        function openStickersModal(target) {
            currentStickerTarget.value = target;
            stickersModalOverlay.classList.add('active');
            loadStickersForSelection();
        }
        
        // Cerrar modal de stickers
        stickersModalClose.addEventListener('click', () => {
            stickersModalOverlay.classList.remove('active');
        });
        
        stickersModalOverlay.addEventListener('click', (e) => {
            if (e.target === stickersModalOverlay) {
                stickersModalOverlay.classList.remove('active');
            }
        });
        
        // Eventos para botones de stickers dentro de los campos
        stickerButtonName.addEventListener('click', () => {
            openStickersModal('name');
        });
        
        stickerButtonDescription.addEventListener('click', () => {
            openStickersModal('description');
        });
        
        // Cargar stickers para selecci√≥n
        async function loadStickersForSelection() {
            stickersGrid.innerHTML = '';
            
            // Usar el mapa que ya tenemos cargado si existe
            if (stickersMap.size > 0) {
                stickersMap.forEach((data, key) => {
                    const stickerElement = document.createElement('div');
                    stickerElement.className = 'sticker-item';
                    stickerElement.innerHTML = `
                        <img src="${data}" alt="Sticker" class="sticker-image">
                    `;
                    
                    stickerElement.addEventListener('click', () => {
                        insertStickerIntoField(key, data);
                    });
                    
                    stickersGrid.appendChild(stickerElement);
                });
            } else {
                // Si por alguna raz√≥n el mapa est√° vac√≠o, intentar cargar de nuevo
                try {
                    await loadStickersData();
                    if (stickersMap.size === 0) {
                        stickersGrid.innerHTML = '<div style="grid-column: 1 / -1; text-align: center; padding: 20px; color: #bbb;">No hay stickers disponibles.</div>';
                    } else {
                        // Recursivamente llamar para pintar
                        loadStickersForSelection();
                    }
                } catch (error) {
                    stickersGrid.innerHTML = '<div style="grid-column: 1 / -1; text-align: center; padding: 20px; color: #e74c3c;">Error al cargar los stickers.</div>';
                }
            }
        }
        
        // Insertar sticker en el campo correspondiente
        function insertStickerIntoField(stickerKey, stickerData) {
            const target = currentStickerTarget.value;
            let editableField;
            let hiddenField;
            
            if (target === 'name') {
                editableField = groupNameEditable;
                hiddenField = groupNameHidden;
            } else if (target === 'description') {
                editableField = groupDescriptionEditable;
                hiddenField = groupDescriptionHidden;
            }
            
            if (!editableField) return;
            
            // Enfocar el campo editable
            editableField.focus();
            
            // Crear un elemento img para el sticker
            const stickerImg = document.createElement('img');
            stickerImg.src = stickerData;
            stickerImg.alt = 'Sticker';
            stickerImg.style.width = '24px';
            stickerImg.style.height = '24px';
            stickerImg.style.verticalAlign = 'middle';
            stickerImg.style.margin = '0 2px';
            stickerImg.setAttribute('data-sticker-key', stickerKey);
            
            // Insertar la imagen en el campo editable
            const selection = window.getSelection();
            if (selection.rangeCount > 0) {
                const range = selection.getRangeAt(0);
                range.deleteContents();
                range.insertNode(stickerImg);
                range.setStartAfter(stickerImg);
                range.setEndAfter(stickerImg);
                selection.removeAllRanges();
                selection.addRange(range);
            } else {
                editableField.appendChild(stickerImg);
            }
            
            // Actualizar el campo oculto
            updateHiddenFieldFromEditable(target);
            
            // Cerrar el modal
            stickersModalOverlay.classList.remove('active');
        }
        
        // Funci√≥n para actualizar el campo oculto a partir del contenido editable
        function updateHiddenFieldFromEditable(fieldType) {
            let editableField, hiddenField;
            
            if (fieldType === 'name') {
                editableField = groupNameEditable;
                hiddenField = groupNameHidden;
            } else if (fieldType === 'description') {
                editableField = groupDescriptionEditable;
                hiddenField = groupDescriptionHidden;
            } else {
                return;
            }
            
            if (!editableField || !hiddenField) return;
            
            // Recorrer todos los nodos del campo editable
            let hiddenValue = '';
            const nodes = editableField.childNodes;
            
            for (const node of nodes) {
                if (node.nodeType === Node.TEXT_NODE) {
                    hiddenValue += node.textContent;
                } else if (node.nodeType === Node.ELEMENT_NODE && node.tagName === 'IMG') {
                    const stickerKey = node.getAttribute('data-sticker-key');
                    if (stickerKey) {
                        hiddenValue += `[sticker:${stickerKey}]`;
                    }
                } else if (node.nodeType === Node.ELEMENT_NODE) {
                    // Si hay otros elementos, agregar su texto
                    hiddenValue += node.textContent;
                }
            }
            
            hiddenField.value = hiddenValue;
        }
        
        // Eventos para actualizar campos ocultos cuando se edita
        if (groupNameEditable) {
            groupNameEditable.addEventListener('input', () => {
                updateHiddenFieldFromEditable('name');
            });
            
            groupNameEditable.addEventListener('paste', (e) => {
                // Permitir pegar texto pero no HTML
                e.preventDefault();
                const text = e.clipboardData.getData('text/plain');
                document.execCommand('insertText', false, text);
            });
        }
        
        if (groupDescriptionEditable) {
            groupDescriptionEditable.addEventListener('input', () => {
                updateHiddenFieldFromEditable('description');
            });
            
            groupDescriptionEditable.addEventListener('paste', (e) => {
                // Permitir pegar texto pero no HTML
                e.preventDefault();
                const text = e.clipboardData.getData('text/plain');
                document.execCommand('insertText', false, text);
            });
        }
        
        // Procesar texto para mostrar stickers - AHORA USA EL MAPA PRECARGADO
        function processStickersInText(text) {
            if (!text) return text;
            
            // Buscar patrones [sticker:KEY] y reemplazar por im√°genes
            const stickerRegex = /\[sticker:([^\]]+)\]/g;
            return text.replace(stickerRegex, (match, key) => {
                const stickerData = stickersMap.get(key);
                if (stickerData) {
                    return `<img src="${stickerData}" alt="Sticker" style="width: 20px; height: 20px; vertical-align: middle; margin: 0 2px;" data-sticker-key="${key}">`;
                } else {
                    return `<span style="display:inline-block; width:20px; height:20px; background:#2a2a2a; border-radius:4px; vertical-align:middle; margin:0 2px;" title="Sticker no encontrado"></span>`;
                }
            });
        }
        
        // Cargar contenido en campos editables
        function loadContentToEditable(content, fieldType) {
            let editableField;
            
            if (fieldType === 'name') {
                editableField = groupNameEditable;
            } else if (fieldType === 'description') {
                editableField = groupDescriptionEditable;
            }
            
            if (!editableField || !content) return;
            
            const stickerRegex = /\[sticker:([^\]]+)\]/g;
            let htmlContent = '';
            let lastIndex = 0;
            let match;
            
            while ((match = stickerRegex.exec(content)) !== null) {
                htmlContent += content.substring(lastIndex, match.index);
                const stickerKey = match[1];
                const stickerData = stickersMap.get(stickerKey);
                
                if (stickerData) {
                    htmlContent += `<img src="${stickerData}" alt="Sticker" style="width: 24px; height: 24px; vertical-align: middle; margin: 0 2px;" data-sticker-key="${stickerKey}">`;
                } else {
                    htmlContent += `<span style="display:inline-block; width:24px; height:24px; background:#2a2a2a; border-radius:4px; vertical-align:middle; margin:0 2px;" title="Sticker no encontrado"></span>`;
                }
                
                lastIndex = stickerRegex.lastIndex;
            }
            
            htmlContent += content.substring(lastIndex);
            editableField.innerHTML = htmlContent;
            updateHiddenFieldFromEditable(fieldType);
        }
        
        // ========== FUNCIONES DE ADMIN PARA STICKERS ==========
        
        // Cargar stickers en el panel de admin
        async function loadAdminStickers() {
            showLoading(stickersLoading);
            adminStickersGrid.innerHTML = '';
            
            try {
                // Usamos el mapa precargado si es posible, o refrescamos
                await loadStickersData();
                
                if (stickersMap.size === 0) {
                    adminStickersGrid.innerHTML = '<div style="grid-column: 1 / -1; text-align: center; padding: 40px 20px; color: #bbb;">No hay stickers. Sube el primero.</div>';
                    hideLoading(stickersLoading);
                    return;
                }
                
                adminStickersGrid.innerHTML = '';
                
                stickersMap.forEach((data, key) => {
                    createAdminStickerItem(data, key);
                });
                
                hideLoading(stickersLoading);
            } catch (error) {
                console.error('Error cargando stickers para admin:', error);
                hideLoading(stickersLoading);
                adminStickersGrid.innerHTML = '<div style="grid-column: 1 / -1; text-align: center; padding: 40px 20px; color: #e74c3c;">Error al cargar los stickers.</div>';
            }
        }
        
        function createAdminStickerItem(data, key) {
            const stickerElement = document.createElement('div');
            stickerElement.className = 'sticker-item';
            stickerElement.innerHTML = `
                <img src="${data}" alt="Sticker" class="sticker-image">
                <button class="sticker-delete-btn" data-key="${key}">Eliminar</button>
            `;
            
            adminStickersGrid.appendChild(stickerElement);
            
            stickerElement.querySelector('.sticker-delete-btn').addEventListener('click', async (e) => {
                e.stopPropagation(); // Evitar click en la imagen
                if (confirm('¬øEst√°s seguro de que quieres eliminar este sticker?')) {
                    try {
                        await database.ref('stickers/' + key).remove();
                        stickerElement.remove();
                        stickersMap.delete(key);
                    } catch (error) {
                        console.error('Error eliminando sticker:', error);
                        alert('Error al eliminar el sticker');
                    }
                }
            });
        }
        
        adminStickerUploadArea.addEventListener('click', () => {
            adminStickerFileInput.click();
        });
        
        let adminStickerFile = null;
        
        adminStickerFileInput.addEventListener('change', function() {
            if (this.files && this.files[0]) {
                adminStickerFile = this.files[0];
                
                const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp'];
                if (!validTypes.includes(adminStickerFile.type)) {
                    alert('Solo se permiten im√°genes (JPEG, PNG, GIF, WebP)');
                    this.value = '';
                    adminStickerFile = null;
                    return;
                }
                
                if (adminStickerFile.size > 2 * 1024 * 1024) {
                    alert('El archivo es demasiado grande. M√°ximo 2MB');
                    this.value = '';
                    adminStickerFile = null;
                    return;
                }
            }
        });
        
        adminUploadStickerButton.addEventListener('click', async () => {
            if (!adminStickerFile) {
                alert('Selecciona un archivo primero');
                return;
            }
            
            try {
                const base64Data = await convertImageToBase64(adminStickerFile);
                
                adminUploadStickerButton.disabled = true;
                adminUploadStickerButton.textContent = 'Subiendo...';
                
                const newStickerRef = database.ref('stickers').push();
                const stickerKey = newStickerRef.key;
                await newStickerRef.set({
                    data: base64Data,
                    name: adminStickerFile.name,
                    type: adminStickerFile.type,
                    uploadedAt: new Date().toISOString()
                });
                
                stickersMap.set(stickerKey, base64Data);
                
                adminStickerFileInput.value = '';
                adminStickerFile = null;
                adminUploadStickerButton.disabled = false;
                adminUploadStickerButton.textContent = 'Subir Sticker';
                
                alert('Sticker subido exitosamente');
                await loadAdminStickers();
                
            } catch (error) {
                console.error('Error subiendo sticker:', error);
                adminUploadStickerButton.disabled = false;
                adminUploadStickerButton.textContent = 'Subir Sticker';
                alert('Error al subir el sticker');
            }
        });
        
        // ========== FUNCIONES GENERALES ==========
        
        function getSessionId() {
            let sessionId = localStorage.getItem('redview_session_id');
            if (!sessionId) {
                sessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('redview_session_id', sessionId);
            }
            return sessionId;
        }
        
        function getOrCreateUserId() {
            let userId = localStorage.getItem('redview_user_id');
            if (!userId) {
                return null;
            }
            return userId;
        }
        
        function generateUserIdForPublishing() {
            let userId = localStorage.getItem('redview_user_id');
            if (!userId) {
                userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('redview_user_id', userId);
                registerUserOnFirstPublish(userId);
            }
            currentUserId = userId;
            return userId;
        }

        // Funci√≥n para mezclar un array aleatoriamente (Fisher-Yates Shuffle)
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }
        
        async function registerUserOnFirstPublish(userId) {
            try {
                const userRef = database.ref('usuarios/' + userId);
                const snapshot = await userRef.once('value');
                if (!snapshot.exists()) {
                    await userRef.set({
                        id: userId,
                        fechaRegistro: new Date().toISOString(),
                        gruposPublicados: 0,
                        ultimaConexion: new Date().toISOString()
                    });
                }
            } catch (error) {
                console.error('Error registrando usuario:', error);
            }
        }
        
        async function updateUserLastConnection(userId) {
            try {
                if (!userId) return;
                const userRef = database.ref('usuarios/' + userId);
                const snapshot = await userRef.once('value');
                if (snapshot.exists()) {
                    await userRef.update({
                        ultimaConexion: new Date().toISOString()
                    });
                }
            } catch (error) {
                console.error('Error actualizando √∫ltima conexi√≥n:', error);
            }
        }
        
        function convertImageToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }
        
        function getImageSource(grupo) {
            if (grupo.imagen) {
                if (grupo.imagen.startsWith('data:image')) return grupo.imagen;
                else if (grupo.imagen.startsWith('http')) return grupo.imagen;
            }
            else if (grupo.imageBase64 && grupo.imageBase64.startsWith('data:image')) {
                return grupo.imageBase64;
            }
            else if (grupo.imageUrl && grupo.imageUrl.startsWith('http')) {
                return grupo.imageUrl;
            }
            else {
                return 'https://images.unsplash.com/photo-1552664730-d307ca884978?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80';
            }
        }
        
        function showLoading(loader) {
            if (loader) loader.style.display = 'block';
        }
        
        function hideLoading(loader) {
            if (loader) loader.style.display = 'none';
        }
        
        const toggleSearchBar = (show) => {
            if (show) {
                searchBar.style.display = 'flex';
                searchInput.focus();
            } else {
                searchBar.style.display = 'none';
                searchInput.value = '';
                restoreAllCards();
            }
        };
        
        const restoreAllCards = () => {
            const cards = document.querySelectorAll('.card');
            cards.forEach(card => {
                card.style.display = 'flex';
            });
        };
        
        const filterCardsByTags = (searchTerm) => {
            const cards = document.querySelectorAll('.card');
            const term = searchTerm.toLowerCase().trim();
            
            if (!term) {
                restoreAllCards();
                return;
            }
            
            const searchTerms = term.split(/[, ]+/).filter(t => t.length > 0);
            
            cards.forEach(card => {
                let tags = card.dataset.tags || '';
                const hasMatch = searchTerms.some(searchTerm => tags.includes(searchTerm));
                const title = card.querySelector('.card-title')?.textContent.toLowerCase() || '';
                const description = card.querySelector('.card-description')?.textContent.toLowerCase() || '';
                const titleMatch = searchTerms.some(searchTerm => title.includes(searchTerm));
                const descriptionMatch = searchTerms.some(searchTerm => description.includes(searchTerm));
                
                if (hasMatch || titleMatch || descriptionMatch) {
                    card.style.display = 'flex';
                } else {
                    card.style.display = 'none';
                }
            });
        };
        
        const updateSearchIconVisibility = () => {
            if (body.classList.contains('show-my-groups') || body.classList.contains('show-admin')) {
                searchIcon.style.display = 'none';
            } else {
                searchIcon.style.display = 'block';
            }
        };
        
        const updateBottomBarActive = () => {
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            if (body.classList.contains('show-my-groups')) {
                myGroupsButton.classList.add('active');
            } else if (body.classList.contains('show-admin')) {
                adminButton.classList.add('active');
            } else {
                homeButton.classList.add('active');
            }
        };
        
        menuButton.addEventListener('click', () => {
            resetPublishForm();
            body.classList.add('menu-open');
            body.classList.remove('show-my-groups');
            body.classList.remove('show-admin');
            updateSearchIconVisibility();
            updateBottomBarActive();
        });
        
        const closePublishMenu = () => {
            body.classList.remove('menu-open');
            resetPublishForm();
        };
        
        closeMenuButton.addEventListener('click', closePublishMenu);
        
        function resetPublishForm() {
            isEditing = false;
            currentEditGroupKey = null;
            currentEditGroupType = null;
            editingGroupId.value = '';
            editingGroupType.value = '';
            currentStickerTarget.value = '';
            
            if (groupNameEditable) groupNameEditable.innerHTML = '';
            if (groupDescriptionEditable) groupDescriptionEditable.innerHTML = '';
            
            if (groupNameHidden) groupNameHidden.value = '';
            if (groupDescriptionHidden) groupDescriptionHidden.value = '';
            
            document.getElementById('groupTags').value = '';
            document.getElementById('groupLink').value = '';
            imagePreview.src = '';
            imageUpload.classList.remove('has-image');
            uploadedImageFile = null;
            fileInput.value = '';
            menuTitle.textContent = '‚ù§Ô∏è‚Äçüî• Publicar mis grupos';
            publishFooterButton.textContent = 'Publicar Grupo';
        }
        
        homeButton.addEventListener('click', () => {
            body.classList.remove('show-my-groups');
            body.classList.remove('show-admin');
            updateSearchIconVisibility();
            updateBottomBarActive();
            loadPublishedGroups();
        });
        
        myGroupsButton.addEventListener('click', () => {
            body.classList.add('show-my-groups');
            body.classList.remove('show-admin');
            updateSearchIconVisibility();
            updateBottomBarActive();
            loadMyGroups();
        });
        
        adminButton.addEventListener('click', () => {
            body.classList.add('show-admin');
            body.classList.remove('show-my-groups');
            updateSearchIconVisibility();
            updateBottomBarActive();
            loadAdminData();
        });
        
        searchIcon.addEventListener('click', () => {
            toggleSearchBar(true);
        });
        
        closeSearch.addEventListener('click', () => {
            toggleSearchBar(false);
        });
        
        searchInput.addEventListener('input', (e) => {
            filterCardsByTags(e.target.value);
        });
        
        searchInput.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                toggleSearchBar(false);
            }
        });
        
        adminTitleButton.addEventListener('click', () => {
            adminModalOverlay.classList.add('active');
            adminModalPassword.focus();
        });
        
        adminModalClose.addEventListener('click', () => {
            closeAdminModal();
        });
        
        adminModalOverlay.addEventListener('click', (e) => {
            if (e.target === adminModalOverlay) {
                closeAdminModal();
            }
        });
        
        adminModalSubmit.addEventListener('click', () => {
            const password = adminModalPassword.value;
            if (password === ADMIN_PASSWORD) {
                isAdmin = true;
                adminButton.style.display = 'flex';
                closeAdminModal();
                alert('Acceso de administrador concedido.');
            } else {
                alert('Contrase√±a incorrecta');
                adminModalPassword.value = '';
                adminModalPassword.focus();
            }
        });
        
        adminModalPassword.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                adminModalSubmit.click();
            }
        });
        
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && adminModalOverlay.classList.contains('active')) {
                closeAdminModal();
            }
        });
        
        function closeAdminModal() {
            adminModalOverlay.classList.remove('active');
            adminModalPassword.value = '';
        }
        
        pendingTab.addEventListener('click', () => {
            pendingTab.classList.add('active');
            publishedTab.classList.remove('active');
            stickersTab.classList.remove('active');
            pendingContent.classList.add('active');
            publishedContent.classList.remove('active');
            stickersContent.classList.remove('active');
            loadPendingRequests();
        });
        
        publishedTab.addEventListener('click', () => {
            publishedTab.classList.add('active');
            pendingTab.classList.remove('active');
            stickersTab.classList.remove('active');
            publishedContent.classList.add('active');
            pendingContent.classList.remove('active');
            stickersContent.classList.remove('active');
            loadAdminPublishedGroups();
        });
        
        stickersTab.addEventListener('click', () => {
            stickersTab.classList.add('active');
            pendingTab.classList.remove('active');
            publishedTab.classList.remove('active');
            stickersContent.classList.add('active');
            pendingContent.classList.remove('active');
            publishedContent.classList.remove('active');
            loadAdminStickers();
        });
        
        menuOverlay.addEventListener('click', () => {
            closePublishMenu();
            closeGroupDetails();
        });
        
        imageUpload.addEventListener('click', () => {
            fileInput.click();
        });
        
        fileInput.addEventListener('change', function() {
            if (this.files && this.files[0]) {
                uploadedImageFile = this.files[0];
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    imagePreview.src = e.target.result;
                    imageUpload.classList.add('has-image');
                };
                
                reader.readAsDataURL(this.files[0]);
            }
        });
        
        // ========== FIREBASE LOAD LOGIC - MODIFICADO PARA PARALELISMO ==========
        
        async function loadPublishedGroups() {
            showLoading(mainLoading);
            mainCardsContainer.innerHTML = '';
            
            try {
                // AHORA NO VOLVEMOS A CARGAR STICKERS SI YA EST√ÅN, PERO ASEGURAMOS QUE EXISTAN
                // El DOMContentLoaded ya se encarg√≥, pero por si acaso esta funci√≥n se llama sola:
                if (stickersMap.size === 0) {
                   await loadStickersData();
                }

                const snapshot = await database.ref('grupos').once('value');
                const grupos = snapshot.val();
                
                if (!grupos) {
                    mainCardsContainer.innerHTML = `
                        <div style="grid-column: 1 / -1; text-align: center; padding: 40px 20px; color: #bbb;">
                            No hay grupos publicados a√∫n. S√© el primero en publicar un grupo.
                        </div>
                    `;
                    hideLoading(mainLoading);
                    return;
                }
                
                mainCardsContainer.innerHTML = '';
                
                const gruposArray = Object.entries(grupos).map(([key, value]) => ({ key, ...value }));
                
                // --- CAMBIO: USAR SHUFFLE EN LUGAR DE SORT ---
                // gruposArray.sort(...) <-- Eliminado
                shuffleArray(gruposArray); // <-- Agregado para aleatoriedad
                
                let index = 0;
                
                for (const grupoObj of gruposArray) {
                    const grupo = grupoObj;
                    const key = grupoObj.key;
                    
                    const estado = grupo.estado || grupo.status || '';
                    if (estado === "publicado" || estado === "approved") {
                        await createGroupCard(grupo, key, index + 1, mainCardsContainer);
                        index++;
                    }
                }
                
                if (index === 0) {
                    mainCardsContainer.innerHTML = `
                        <div style="grid-column: 1 / -1; text-align: center; padding: 40px 20px; color: #bbb;">
                            No hay grupos publicados a√∫n.
                        </div>
                    `;
                }
                
                hideLoading(mainLoading);
            } catch (error) {
                console.error('Error cargando grupos:', error);
                hideLoading(mainLoading);
                mainCardsContainer.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 40px 20px; color: #e74c3c;">
                        Error al cargar los grupos.
                    </div>
                `;
            }
        }
        
        async function loadMyGroups() {
            showLoading(myGroupsLoading);
            myGroupsContainer.innerHTML = '';
            
            try {
                currentUserId = getOrCreateUserId();
                if (!currentUserId) {
                    myGroupsContainer.innerHTML = `
                        <div class="my-group-placeholder">
                            <p style="text-align: center; color: #bbb; padding: 40px 20px;">
                                Tus grupos publicados aparecer√°n aqu√≠.
                            </p>
                        </div>
                    `;
                    hideLoading(myGroupsLoading);
                    return;
                }
                
                // Cargar todo en paralelo
                const [snapshotSolicitudes, snapshotGrupos] = await Promise.all([
                    database.ref('solicitudes').orderByChild('userid').equalTo(currentUserId).once('value'),
                    database.ref('grupos').orderByChild('userid').equalTo(currentUserId).once('value')
                ]);

                const misSolicitudes = snapshotSolicitudes.val();
                const misGruposPublicados = snapshotGrupos.val();
                
                if (!misSolicitudes && !misGruposPublicados) {
                    myGroupsContainer.innerHTML = `
                        <div class="my-group-placeholder">
                            <p style="text-align: center; color: #bbb; padding: 40px 20px;">
                                Tus grupos publicados aparecer√°n aqu√≠.
                            </p>
                        </div>
                    `;
                    hideLoading(myGroupsLoading);
                    return;
                }
                
                myGroupsContainer.innerHTML = '';
                const allGroups = [];
                
                if (misSolicitudes) {
                    for (const key in misSolicitudes) {
                        allGroups.push({ key, ...misSolicitudes[key], tipo: 'solicitud' });
                    }
                }
                
                if (misGruposPublicados) {
                    for (const key in misGruposPublicados) {
                        allGroups.push({ key, ...misGruposPublicados[key], tipo: 'grupo' });
                    }
                }
                
                allGroups.sort((a, b) => {
                    const dateA = a.fecha ? new Date(a.fecha).getTime() : 0;
                    const dateB = b.fecha ? new Date(b.fecha).getTime() : 0;
                    return dateB - dateA;
                });
                
                for (const groupObj of allGroups) {
                    await createMyGroupCard(groupObj, groupObj.key, groupObj.tipo);
                }
                
                hideLoading(myGroupsLoading);
            } catch (error) {
                console.error('Error cargando mis grupos:', error);
                hideLoading(myGroupsLoading);
                myGroupsContainer.innerHTML = `
                    <div style="text-align: center; padding: 40px 20px; color: #e74c3c;">
                        Error al cargar tus grupos.
                    </div>
                `;
            }
        }
        
        async function loadAdminData() {
            // Paralelizar cargas de admin
            await Promise.all([
                loadPendingRequests(),
                loadAdminPublishedGroups(),
                updateAdminStats()
            ]);
        }
        
        async function loadPendingRequests() {
            showLoading(pendingLoading);
            requestsContainer.innerHTML = '';
            
            try {
                const snapshot = await database.ref('solicitudes').once('value');
                const solicitudes = snapshot.val();
                
                if (!solicitudes) {
                    requestsContainer.innerHTML = `
                        <div class="request-placeholder">
                            <p style="text-align: center; color: #bbb; padding: 40px 20px;">
                                No hay solicitudes pendientes.
                            </p>
                        </div>
                    `;
                    hideLoading(pendingLoading);
                    return;
                }
                
                requestsContainer.innerHTML = '';
                
                const solicitudesArray = Object.entries(solicitudes).map(([key, value]) => ({ key, ...value }));
                
                solicitudesArray.sort((a, b) => {
                    const dateA = a.fecha ? new Date(a.fecha).getTime() : 0;
                    const dateB = b.fecha ? new Date(b.fecha).getTime() : 0;
                    return dateB - dateA;
                });
                
                for (const solicitudObj of solicitudesArray) {
                    const estado = solicitudObj.estado || solicitudObj.status || '';
                    if (estado === "pendiente" || estado === "pending" || estado === "") {
                        await createRequestCard(solicitudObj, solicitudObj.key);
                    }
                }
                
                hideLoading(pendingLoading);
            } catch (error) {
                console.error('Error cargando solicitudes:', error);
                hideLoading(pendingLoading);
            }
        }
        
        async function loadAdminPublishedGroups() {
            showLoading(publishedLoading);
            adminPublishedContainer.innerHTML = '';
            
            try {
                const snapshot = await database.ref('grupos').once('value');
                const grupos = snapshot.val();
                
                if (!grupos) {
                    adminPublishedContainer.innerHTML = `
                        <div class="published-placeholder">
                            <p style="text-align: center; color: #bbb; padding: 40px 20px;">
                                No hay grupos publicados.
                            </p>
                        </div>
                    `;
                    hideLoading(publishedLoading);
                    return;
                }
                
                adminPublishedContainer.innerHTML = '';
                
                const gruposArray = Object.entries(grupos).map(([key, value]) => ({ key, ...value }));
                
                gruposArray.sort((a, b) => {
                    const dateA = a.fecha ? new Date(a.fecha).getTime() : 0;
                    const dateB = b.fecha ? new Date(b.fecha).getTime() : 0;
                    return dateB - dateA;
                });
                
                for (const grupoObj of gruposArray) {
                    const estado = grupoObj.estado || grupoObj.status || '';
                    if (estado === "publicado" || estado === "approved") {
                        await createAdminPublishedCard(grupoObj, grupoObj.key);
                    }
                }
                
                hideLoading(publishedLoading);
            } catch (error) {
                console.error('Error cargando grupos admin:', error);
                hideLoading(publishedLoading);
            }
        }
        
        async function updateAdminStats() {
            try {
                // Ejecutar en paralelo
                const [publishedSnapshot, pendingSnapshot] = await Promise.all([
                    database.ref('grupos').once('value'),
                    database.ref('solicitudes').once('value')
                ]);

                let publishedCount = 0;
                const grupos = publishedSnapshot.val();
                if (grupos) {
                    for (const key in grupos) {
                        const estado = grupos[key].estado || grupos[key].status || '';
                        if (estado === "publicado" || estado === "approved") publishedCount++;
                    }
                }
                
                let pendingCount = 0;
                const solicitudes = pendingSnapshot.val();
                if (solicitudes) {
                    for (const key in solicitudes) {
                        const estado = solicitudes[key].estado || solicitudes[key].status || '';
                        if (estado === "pendiente" || estado === "pending" || estado === "") pendingCount++;
                    }
                }
                
                statsPublished.textContent = publishedCount;
                statsPending.textContent = pendingCount;
            } catch (error) {
                console.error('Error stats:', error);
            }
        }
        
        // Crear tarjetas
        async function createGroupCard(grupo, key, groupNumber, container) {
            const groupElement = document.createElement('div');
            groupElement.className = 'card';
            groupElement.setAttribute('data-group', groupNumber);
            groupElement.setAttribute('data-key', key);
            
            const tags = grupo.etiquetas || grupo.tags || '';
            if (tags) groupElement.setAttribute('data-tags', tags.toLowerCase());
            
            const imageSrc = getImageSource(grupo);
            
            // AQUI ESTA LA CLAVE: processStickersInText ahora funciona porque stickersMap est√° lleno
            let nombre = processStickersInText(grupo.nombre || grupo.name || 'Sin nombre');
            let descripcion = processStickersInText(grupo.descripcion || grupo.description || 'Sin descripci√≥n');
            
            groupElement.innerHTML = `
                <img src="${imageSrc}" alt="Grupo" class="card-image">
                <div class="card-content">
                    <h3 class="card-title">${nombre}</h3>
                    <p class="card-description">${descripcion}</p>
                    <button class="card-button" onclick="openGroupDetails('${key}', 'grupo')">Ver</button>
                </div>
            `;
            
            groupElement.addEventListener('click', (e) => {
                if (!e.target.classList.contains('card-button')) {
                    openGroupDetails(key, 'grupo');
                }
            });
            
            container.appendChild(groupElement);
        }
        
        async function createMyGroupCard(grupo, key, tipo = 'grupo') {
            const groupElement = document.createElement('div');
            groupElement.className = 'card';
            groupElement.setAttribute('data-key', key);
            groupElement.setAttribute('data-tipo', tipo);
            
            const tags = grupo.etiquetas || grupo.tags || '';
            if (tags) groupElement.setAttribute('data-tags', tags.toLowerCase());
            
            let statusClass = 'status-review';
            let statusText = 'Revisi√≥n';
            const estado = grupo.estado || grupo.status || 'pendiente';
            
            if (estado === "publicado" || estado === "approved") {
                statusClass = 'status-published';
                statusText = 'Publicado';
            } else if (estado === "rechazado" || estado === "rejected") {
                statusClass = 'status-rejected';
                statusText = 'Rechazado';
            }
            
            const imageSrc = getImageSource(grupo);
            let nombre = processStickersInText(grupo.nombre || grupo.name || 'Sin nombre');
            let descripcion = processStickersInText(grupo.descripcion || grupo.description || 'Sin descripci√≥n');
            const viewsCount = grupo.vistas || grupo.visualizaciones || 0;
            const membersCount = grupo.uniones || 0;
            const tagsArray = tags ? tags.split(',').map(tag => tag.trim()).filter(tag => tag.length > 0) : [];
            
            groupElement.innerHTML = `
                <img src="${imageSrc}" alt="Grupo" class="card-image">
                <div class="card-content">
                    <h3 class="card-title">${nombre}</h3>
                    <p class="card-description">${descripcion}</p>
                    <div class="my-group-tags">
                        ${tagsArray.map(tag => `<span class="my-group-tag">${tag}</span>`).join('')}
                    </div>
                    <div class="my-group-footer">
                        <div class="my-group-stats">
                            <div class="my-group-stat">
                                <div class="my-group-stat-number">${viewsCount}</div>
                                <div class="my-group-stat-label">Visualizaciones</div>
                            </div>
                            <div class="my-group-stat">
                                <div class="my-group-stat-number">${membersCount}</div>
                                <div class="my-group-stat-label">Uniones</div>
                            </div>
                        </div>
                        <div class="group-status ${statusClass}">${statusText}</div>
                    </div>
                    <div class="my-group-actions">
                        <button class="edit-group-btn" data-key="${key}" data-tipo="${tipo}">Editar</button>
                        <button class="delete-group-btn" data-key="${key}" data-tipo="${tipo}">Eliminar</button>
                    </div>
                </div>
            `;
            
            myGroupsContainer.prepend(groupElement);
            
            groupElement.querySelector('.edit-group-btn').addEventListener('click', function(e) {
                e.stopPropagation();
                loadGroupForEdit(key, tipo);
            });
            
            groupElement.querySelector('.delete-group-btn').addEventListener('click', function(e) {
                e.stopPropagation();
                deleteGroup(key, tipo);
            });
        }
        
        async function createRequestCard(solicitud, key) {
            const requestElement = document.createElement('div');
            requestElement.className = 'request-item';
            requestElement.dataset.id = key;
            
            const imageSrc = getImageSource(solicitud);
            let nombre = processStickersInText(solicitud.nombre || solicitud.name || 'Sin nombre');
            let descripcion = processStickersInText(solicitud.descripcion || solicitud.description || 'Sin descripci√≥n');
            
            let date = 'Fecha no disponible';
            if (solicitud.fecha) date = new Date(solicitud.fecha).toLocaleDateString();
            
            const enlace = solicitud.enlace || solicitud.link || '#';
            const tags = solicitud.etiquetas || solicitud.tags || '';
            const tagsArray = tags ? tags.split(',').map(tag => tag.trim()).filter(tag => tag.length > 0) : [];
            
            requestElement.innerHTML = `
                <div class="request-header">
                    <h3 class="request-title">${nombre}</h3>
                    <div class="request-date">${date}</div>
                </div>
                <div class="request-image-container">
                    <img src="${imageSrc}" alt="Solicitud" class="request-image">
                </div>
                <p class="request-description">${descripcion}</p>
                <div class="request-tags">
                    ${tagsArray.map(tag => `<span class="request-tag">${tag}</span>`).join('')}
                </div>
                <div class="request-actions">
                    <a href="${enlace}" target="_blank" class="review-link-btn">Revisar Enlace</a>
                    <button class="reject-btn" onclick="rejectRequest('${key}')">Rechazar</button>
                    <button class="accept-btn" onclick="acceptRequest('${key}')">Aceptar</button>
                </div>
            `;
            
            requestsContainer.appendChild(requestElement);
        }
        
        async function createAdminPublishedCard(grupo, key) {
            const groupElement = document.createElement('div');
            groupElement.className = 'card';
            groupElement.setAttribute('data-key', key);
            
            const imageSrc = getImageSource(grupo);
            let nombre = processStickersInText(grupo.nombre || grupo.name || 'Sin nombre');
            let descripcion = processStickersInText(grupo.descripcion || grupo.description || 'Sin descripci√≥n');
            const viewsCount = grupo.vistas || grupo.visualizaciones || 0;
            const membersCount = grupo.uniones || 0;
            const tags = grupo.etiquetas || grupo.tags || '';
            const tagsArray = tags ? tags.split(',').map(tag => tag.trim()).filter(tag => tag.length > 0) : [];
            
            groupElement.innerHTML = `
                <img src="${imageSrc}" alt="Grupo" class="card-image">
                <div class="card-content">
                    <h3 class="card-title">${nombre}</h3>
                    <p class="card-description">${descripcion}</p>
                    <div class="my-group-tags">
                        ${tagsArray.map(tag => `<span class="my-group-tag">${tag}</span>`).join('')}
                    </div>
                    <div class="my-group-footer">
                        <div class="my-group-stats">
                            <div class="my-group-stat">
                                <div class="my-group-stat-number">${viewsCount}</div>
                                <div class="my-group-stat-label">Visualizaciones</div>
                            </div>
                            <div class="my-group-stat">
                                <div class="my-group-stat-number">${membersCount}</div>
                                <div class="my-group-stat-label">Uniones</div>
                            </div>
                        </div>
                        <div class="group-status status-published">Publicado</div>
                    </div>
                    <div class="my-group-actions">
                        <button class="admin-delete-btn" data-key="${key}">Eliminar Grupo</button>
                    </div>
                </div>
            `;
            
            adminPublishedContainer.appendChild(groupElement);
            
            groupElement.querySelector('.admin-delete-btn').addEventListener('click', function(e) {
                e.stopPropagation();
                deletePublishedGroupFromAdmin(key);
            });
        }
        
        async function loadGroupForEdit(key, tipo) {
            try {
                let grupo;
                if (tipo === 'grupo') {
                    const snapshot = await database.ref('grupos/' + key).once('value');
                    grupo = snapshot.val();
                } else {
                    const snapshot = await database.ref('solicitudes/' + key).once('value');
                    grupo = snapshot.val();
                }
                
                if (!grupo) return;
                
                isEditing = true;
                currentEditGroupKey = key;
                currentEditGroupType = tipo;
                editingGroupId.value = key;
                editingGroupType.value = tipo;
                
                const nombre = grupo.nombre || grupo.name || '';
                const descripcion = grupo.descripcion || grupo.description || '';
                
                groupNameHidden.value = nombre;
                groupDescriptionHidden.value = descripcion;
                
                loadContentToEditable(nombre, 'name');
                loadContentToEditable(descripcion, 'description');
                
                document.getElementById('groupTags').value = grupo.etiquetas || grupo.tags || '';
                document.getElementById('groupLink').value = grupo.enlace || grupo.link || '';
                
                const imageSrc = getImageSource(grupo);
                if (imageSrc && imageSrc.startsWith('data:image')) {
                    imagePreview.src = imageSrc;
                    imageUpload.classList.add('has-image');
                } else if (imageSrc && imageSrc.startsWith('http')) {
                    imagePreview.src = imageSrc;
                    imageUpload.classList.add('has-image');
                } else {
                    imagePreview.src = '';
                    imageUpload.classList.remove('has-image');
                }
                
                uploadedImageFile = null;
                menuTitle.textContent = '‚úèÔ∏è ·¥á·¥Ö…™·¥õ·¥Ä Ä …¢ Ä·¥ú·¥ò·¥è';
                publishFooterButton.textContent = 'Actualizar y enviar a revisi√≥n';
                
                body.classList.add('menu-open');
                body.classList.remove('show-my-groups');
                body.classList.remove('show-admin');
                updateSearchIconVisibility();
                updateBottomBarActive();
                
            } catch (error) {
                console.error('Error editando:', error);
                alert('Error al cargar el grupo para editar');
            }
        }
        
        async function deleteGroup(key, tipo) {
            if (!confirm('¬øEst√°s seguro de que quieres eliminar este grupo?')) return;
            try {
                if (tipo === 'grupo') await database.ref('grupos/' + key).remove();
                else await database.ref('solicitudes/' + key).remove();
                
                alert('Grupo eliminado exitosamente');
                await loadMyGroups();
                if (tipo === 'grupo') await loadPublishedGroups();
            } catch (error) {
                alert('Error al eliminar el grupo');
            }
        }
        
        async function deletePublishedGroupFromAdmin(key) {
            if (!confirm('¬øSeguro que quieres eliminar este grupo publicado?')) return;
            try {
                await database.ref('grupos/' + key).remove();
                alert('Grupo eliminado');
                await loadAdminPublishedGroups();
                await loadPublishedGroups();
                await updateAdminStats();
            } catch (error) {
                alert('Error al eliminar');
            }
        }
        
        async function registerView(groupKey) {
            try {
                const grupoRef = database.ref('grupos/' + groupKey);
                const snapshot = await grupoRef.once('value');
                const grupo = snapshot.val();
                if (!grupo) return { success: false, count: 0 };
                
                const sessionId = getSessionId();
                const vistasSesiones = grupo.vistasSesiones || {};
                
                if (vistasSesiones[sessionId]) {
                    return { success: false, count: grupo.vistas || 0 };
                }
                
                vistasSesiones[sessionId] = { fecha: new Date().toISOString(), sessionId: sessionId };
                const newViews = (grupo.vistas || 0) + 1;
                
                await grupoRef.update({ vistas: newViews, vistasSesiones: vistasSesiones });
                return { success: true, count: newViews };
            } catch (error) {
                return { success: false, count: 0 };
            }
        }
        
        async function registerJoin(groupKey) {
            try {
                const grupoRef = database.ref('grupos/' + groupKey);
                const snapshot = await grupoRef.once('value');
                const grupo = snapshot.val();
                if (!grupo) return { success: false, count: 0 };
                
                const sessionId = getSessionId();
                const unionesSesiones = grupo.unionesSesiones || {};
                
                if (unionesSesiones[sessionId]) {
                    return { success: false, count: grupo.uniones || 0 };
                }
                
                unionesSesiones[sessionId] = { fecha: new Date().toISOString(), sessionId: sessionId };
                const newMembers = (grupo.uniones || 0) + 1;
                
                await grupoRef.update({ uniones: newMembers, unionesSesiones: unionesSesiones });
                return { success: true, count: newMembers };
            } catch (error) {
                return { success: false, count: 0 };
            }
        }
        
        async function openGroupDetails(key, type) {
            try {
                let grupo;
                if (type === 'grupo') {
                    const snapshot = await database.ref('grupos/' + key).once('value');
                    grupo = snapshot.val();
                } else {
                    const snapshot = await database.ref('solicitudes/' + key).once('value');
                    grupo = snapshot.val();
                }
                
                if (!grupo) return;
                currentGroupDetails = { key, grupo, type };
                
                let nombre = processStickersInText(grupo.nombre || grupo.name || 'Sin nombre');
                let descripcion = processStickersInText(grupo.descripcion || grupo.description || 'Sin descripci√≥n');
                
                document.getElementById('groupTitle').innerHTML = nombre;
                document.getElementById('groupDescriptionDetails').innerHTML = descripcion;
                document.getElementById('groupImageLarge').src = getImageSource(grupo);
                
                let fecha = 'Fecha no disponible';
                if (grupo.fecha) fecha = new Date(grupo.fecha).toLocaleDateString();
                document.getElementById('publishDate').textContent = `Publicado: ${fecha}`;
                
                const tagsContainer = document.getElementById('groupTagsDetails');
                tagsContainer.innerHTML = '';
                const tags = grupo.etiquetas || grupo.tags || '';
                if (tags) {
                    tags.split(',').forEach(tag => {
                        const trimmedTag = tag.trim();
                        if (trimmedTag) {
                            const span = document.createElement('span');
                            span.className = 'tag';
                            span.textContent = trimmedTag;
                            tagsContainer.appendChild(span);
                        }
                    });
                }
                
                document.getElementById('viewsCount').textContent = grupo.vistas || 0;
                document.getElementById('membersCount').textContent = grupo.uniones || 0;
                
                if (type === 'grupo') {
                    const result = await registerView(key);
                    if (result.success) document.getElementById('viewsCount').textContent = result.count;
                }
                
                body.classList.add('group-details-open');
            } catch (error) {
                console.error('Error detalles:', error);
            }
        }
        
        async function updateCardCounters(groupKey, type, newValue) {
            const cards = document.querySelectorAll(`.card[data-key="${groupKey}"]`);
            cards.forEach(card => {
                const statElements = card.querySelectorAll('.my-group-stat-number');
                if (type === 'views' && statElements.length > 0) statElements[0].textContent = newValue;
                else if (type === 'members' && statElements.length > 1) statElements[1].textContent = newValue;
            });
        }
        
        const closeGroupDetails = () => {
            body.classList.remove('group-details-open');
        };
        
        backButton.addEventListener('click', closeGroupDetails);
        
        joinButton.addEventListener('click', async () => {
            if (currentGroupDetails && currentGroupDetails.type === 'grupo') {
                const result = await registerJoin(currentGroupDetails.key);
                if (result.success) {
                    document.getElementById('membersCount').textContent = result.count;
                    await updateCardCounters(currentGroupDetails.key, 'members', result.count);
                    await loadPublishedGroups();
                    await loadMyGroups();
                }
                
                const enlace = currentGroupDetails.grupo.enlace || currentGroupDetails.grupo.link || '#';
                if (enlace !== '#') window.open(enlace, '_blank');
            } else {
                alert('No se puede unir a este grupo en este momento.');
            }
        });
        
        window.acceptRequest = async function(requestKey) {
            if (!confirm('¬øAceptar solicitud?')) return;
            try {
                const snapshot = await database.ref('solicitudes/' + requestKey).once('value');
                const solicitud = snapshot.val();
                
                const grupoAprobado = {
                    nombre: solicitud.nombre || solicitud.name,
                    descripcion: solicitud.descripcion || solicitud.description,
                    etiquetas: solicitud.etiquetas || solicitud.tags,
                    enlace: solicitud.enlace || solicitud.link,
                    imagen: solicitud.imagen || solicitud.imageBase64 || null,
                    userid: solicitud.userid || null,
                    estado: "publicado",
                    fecha: new Date().toISOString(),
                    vistas: 0,
                    uniones: 0,
                    vistasSesiones: {},
                    unionesSesiones: {}
                };
                
                await database.ref('grupos/' + requestKey).set(grupoAprobado);
                await database.ref('solicitudes/' + requestKey).remove();
                
                await updateAdminStats();
                await loadPendingRequests();
                await loadPublishedGroups();
                alert('Solicitud aceptada');
            } catch (error) {
                alert('Error');
            }
        };
        
        window.rejectRequest = async function(requestKey) {
            if (!confirm('¬øRechazar solicitud?')) return;
            try {
                await database.ref('solicitudes/' + requestKey).update({ estado: "rechazado", status: "rejected" });
                await updateAdminStats();
                await loadPendingRequests();
                alert('Solicitud rechazada');
            } catch (error) {
                alert('Error');
            }
        };
        
        publishFooterButton.addEventListener('click', async () => {
            const groupName = groupNameHidden.value.trim();
            const groupDescription = groupDescriptionHidden.value.trim();
            const groupTags = document.getElementById('groupTags').value.trim();
            const groupLink = document.getElementById('groupLink').value.trim();
            
            if (!groupName || !groupDescription || !groupTags || !groupLink) {
                alert('Completa todos los campos');
                return;
            }
            
            publishFooterButton.disabled = true;
            
            try {
                let imagenBase64 = null;
                if (uploadedImageFile) {
                    imagenBase64 = await convertImageToBase64(uploadedImageFile);
                } else if (isEditing) {
                    let grupoExistente;
                    if (currentEditGroupType === 'grupo') {
                        const snapshot = await database.ref('grupos/' + currentEditGroupKey).once('value');
                        grupoExistente = snapshot.val();
                    } else {
                        const snapshot = await database.ref('solicitudes/' + currentEditGroupKey).once('value');
                        grupoExistente = snapshot.val();
                    }
                    if (grupoExistente) imagenBase64 = grupoExistente.imagen || grupoExistente.imageBase64 || null;
                }
                
                if (isEditing) {
                    const solicitudActualizada = {
                        nombre: groupName,
                        descripcion: groupDescription,
                        etiquetas: groupTags,
                        enlace: groupLink,
                        imagen: imagenBase64,
                        userid: currentUserId,
                        estado: "pendiente",
                        fecha: new Date().toISOString()
                    };
                    
                    if (currentEditGroupType === 'grupo') await database.ref('grupos/' + currentEditGroupKey).remove();
                    
                    if (currentEditGroupType === 'solicitud') await database.ref('solicitudes/' + currentEditGroupKey).update(solicitudActualizada);
                    else await database.ref('solicitudes').push(solicitudActualizada);
                    
                    closePublishMenu();
                    alert('Grupo actualizado y enviado a revisi√≥n.');
                    await loadMyGroups();
                    await loadPublishedGroups();
                    
                } else {
                    const userId = generateUserIdForPublishing();
                    const solicitud = {
                        nombre: groupName,
                        descripcion: groupDescription,
                        etiquetas: groupTags,
                        enlace: groupLink,
                        imagen: imagenBase64,
                        userid: userId,
                        estado: "pendiente",
                        fecha: new Date().toISOString(),
                        vistas: 0, uniones: 0
                    };
                    
                    await database.ref('solicitudes').push(solicitud);
                    resetPublishForm();
                    closePublishMenu();
                    alert('Grupo enviado a revisi√≥n.');
                    body.classList.add('show-my-groups');
                    updateBottomBarActive();
                    await loadMyGroups();
                }
            } catch (error) {
                console.error(error);
                alert('Error');
            } finally {
                publishFooterButton.disabled = false;
            }
        });
        
        // ========== DOM CONTENT LOADED OPTIMIZADO ==========
        window.addEventListener('DOMContentLoaded', async () => {
            currentUserId = getOrCreateUserId();
            if (currentUserId) await updateUserLastConnection(currentUserId);
            
            // CARGA PARALELA: Cargamos Stickers y Grupos a la vez para mejorar velocidad
            // La funci√≥n loadStickersData llenar√° el mapa ANTES de que loadPublishedGroups termine si es posible,
            // pero si no, hemos puesto un await dentro de loadPublishedGroups tambi√©n.
            // Promise.all espera a que AMBOS terminen antes de seguir, pero como son promesas,
            // se inician simult√°neamente.
            
            showLoading(mainLoading);
            
            await Promise.all([
                loadStickersData(),
                loadPublishedGroups()
            ]);
            
            updateSearchIconVisibility();
            updateBottomBarActive();
        });
    </script>
</body>
</html>
